README.debug.me

----------------------------------------------------------
Fase 9 :: 
----------------------------------------------------------
--comparar quais arquivos ou alteraÃ§Ãµes ainda precisam ser feitas
	--arquivos acrescentados
		--app\Console\Commands\...

	--arquivos/pastas conferidos
		--app\Console\...
		--app\Exceptions\...
		--app\Helpers\...
		--app\Http\Controllers\...
		--app\Http\Middleware\...
		--app\Http\Kernel.php
		--app\Models\...
		--app\Providers\...
		
		--o antigo \Services\ContextService.php agora Ã© \LoginController
		
		--config\...
		--database\...
		--public\...
		--resources\css, js, lang
		--resources\views\...
		--routes\...
		--storage\...

		--continue comparando cada arquivo do syrios com o do syriosia para completar essa migraÃ§Ã£o

----------------------------------------------------------
Fase 8 :: sucesso :: aparentemente roda tudo no railway (nem todos os blades foram testados ainda)
----------------------------------------------------------
--migrar o controlle e as viwes de Secretaria e Escola
	--arquivos acrescentados
		--app\Http\Controllers\Secretaria\...tudo
		--resources\views\secretaria\...tudo
		--app\Http\Controllers\Escola\...tudo
		--resources\views\escola\...tudo

	--Models acrescentados
		--Notificacao
		--OcorrenciaMotivo
		--Regimento
		--RegStatus
		--Sessao
		--VisaoAluno

----------------------------------------------------------
Fase 7 :: sucesso :: aparentemente roda tudo no railway (nem todos os blades foram testados ainda)
----------------------------------------------------------
--migrar o controlle e as viwes do Master
	--arquivos acrescentados
		--app\Http\Controllers\Master\...tudo
		--resources\views\master\...tudo

----------------------------------------------------------
Fase 6 :: sucesso :: pdf agora roda com imagens
----------------------------------------------------------
--corrigindo o problema com as imagens
	--permitir que o git envie as pastas com imagens e pdf
		--img-user
		--logos
		--regimentos
	--alteraÃ§Ã£o do arquivo storage/app/public/.gitignore
		# Permitir pastas especÃ­ficas
		!img-user/
		!img-user/**

		!logos/
		!logos/**

		!regimentos/
		!regimentos/**
--corrigindo erro The PHP GD extension is required, but is not installed.
	--o pdf do railway sÃ³ aceita jpg. com isso nÃ£o precisa do GD

----------------------------------------------------------
Fase 5 :: sucesso :: pdf criado no servidor railway
----------------------------------------------------------
--adicionar rotas de debug para pdf que vem com 0 byte
	--Route::get('/pdf-diag', [DiagController::class, 'pdfDiag'])->name('diag.pdf.diag');
    --Route::get('/pdf-download', [DiagController::class, 'pdfDownloadTest'])->name('diag.pdf.download');
    --alteraÃ§Ã£o do DiagController.php para acrescentar as funÃ§Ãµes
    	--pdfDiag()
    	--pdfDownloadTest()
--corrigindo download de pdf no railway
	--adicionamos app\Helpers\pdf_download.php
	--alteramos o composer.json
		--"app/Helpers/pdf_download.php"
	--rodamos composer dump-autoload


----------------------------------------------------------
Fase 4 :: sucesso :: apesar de comportamento estranho do syriosia_session mudar a cada acesso de rota, e ser criado sem nem fazer login, tudo rodou no railway
----------------------------------------------------------
--arquivos modificados
	--routes\web.php
		--competou-se todas as rotas de uma vez sÃ³
	--resources\views\layouts\app.blades.php
		--reativaÃ§Ã£o da navbar
--arquivos acrescentados
	--App\Models\Disciplina.php
	--App\Models\Aluno.php
	--App\Models\Turma.php
	--App\Models\Enturmacao.php
	--App\Models\ModeloMotivo.php
	--App\Models\DiretorTurma.php
	--resources\views\components\...pdf
	--public\js\...js
--instalaÃ§Ã£o local de pacote pdf
	--composer require barryvdh/laravel-dompdf
--nova rota para tentar apagar cookie
	--kill-cookie


----------------------------------------------------------
Fase 3 :: sucesso :: tudo funcionando no railway
----------------------------------------------------------
--Arquivos modificados
	--app\Http\Controllers\DiagController.php
		--use Illuminate\Support\Facades\Storage;
		--criando a funÃ§Ã£o storage() para o diagnÃ³stico
	--app\Providers\AppServiceProvider.php
		--acrescentou-se mesmo boot() do syrios
	--routes\web.php
		--Route::get('/storage', [DiagController::class, 'storage'])->name('diag.storage');

--Arquivos acrescentados
	--resources\views\diag\storage.blade.php

--Como testar
	--.../syriosia/public/diag/storage
	
----------------------------------------------------------
Fase 2 :: sucesso  :: tudo funcionando do railway
----------------------------------------------------------
	--Arquivos adicionados
		--app\Http\Controllers\Auth\...php
		--app\Helpers\helpers.php
		--app\Http\Controllers\AuthController.php
		--app\Http\Controllers\Professor\...php
		--App\Http\Middleware\EnsureContextSelected.php
		--App\Http\Middleware\RoleMiddleware.php
		--App\Http\Middleware\BaseAuthModel.php
		--App\Http\Middleware\BaseModel.php
		--App\Models\Escola.php
		--App\Models\Ocorrencia.php
		--App\Models\Oferta.php
		--App\Models\Professor.php
		--App\Models\Role.php
		--App\Models\Usuario.php
		--App\Models\UsuarioRole.php
		--resources\views\auth\...php
		--resources\views\professor\...php

	--Arquivos modificados
		--app\Http\Kernel.php
			--'role' => \App\Http\Middleware\RoleMiddleware::class,
	        --'ensure.context' => \App\Http\Middleware\EnsureContextSelected::class,
	    --composer.json
	    	"files": [
	            "app/Helpers/helpers.php"
	        ]
	    --config\auth.php
	    	'users' => [
	            'driver' => 'eloquent',
	            'model' => App\Models\Usuario::class,
	        ],
	    --web.php
	    	--use Illuminate\Http\Request;
			--use Illuminate\Http\Response;
			--use Illuminate\Support\Facades\Session;
			--use Symfony\Component\HttpFoundation\Cookie;
			--use App\Http\Controllers\Auth\LoginController;
	    	--use App\Http\Controllers\Escola\ProfessorController;
			--use App\Http\Controllers\Professor\{
				    DashboardController as ProfessorDashboardController,
				    OfertaController,
				    OcorrenciaController,
				    RelatorioController,
				    PerfilController
				};
	    	
	    	--grupo da rotas web
		    	Route::middleware(['web'])->group(function () {
			    	Route::get('/', fn() => redirect()->route('login'));
				    // Login / Logout (pÃºblicas)
				    Route::get('/login', [LoginController::class, 'showLoginForm'])->name('login');
				    Route::post('/login', [LoginController::class, 'login']);
				    Route::post('/logout', [LoginController::class, 'logout'])->name('logout');
				});

			---grupo de rotas auth
		    	Route::middleware(['auth'])->group(function () {
				    Route::get('/choose-school', [LoginController::class, 'chooseSchool'])->name('choose.school');
				    Route::get('/choose-role/{schoolId}', [LoginController::class, 'chooseRole'])->name('choose.role');
				    Route::post('/set-context', [LoginController::class, 'setContextPost'])->name('set.context');
				});

			--grupo de rotas 'auth' e 'ensure.context'
		    	Route::middleware(['auth', 'ensure.context'])->group(function () {
				    Route::prefix('professor')
				        ->middleware(['role:professor'])
				        ->name('professor.')
				        ->group(function () {

				        [...]

			    	});
			    });

-----------------------------------------------------------
Fase 1 :: sucesso :: sessÃ£o e cookie funcionando
-----------------------------------------------------------
	composer.json
	--alterou-se a versao PHP
		-- "php": "^7.3|^8.0",

	DiagController.php
	--criou-se o controle para fezer diagnÃ³stico da sessÃ£o e cookies
	--criou-se suas rotas
		--Route::get('/diag', [DiagController::class, 'index']);
		--Route::get('/diag/cookie-test', [DiagController::class, 'cookieTest']);
	TrustProxies.php
	--alteraÃ§Ã£o para https
		--protected $proxies = '*';
	    --protected $headers = Request::HEADER_X_FORWARDED_ALL;

	Como testar resultado inicial com sucesso dentro e fora do Middleware
		--passando por dentro middleware
			--1Âº acesse /diag/cookie-test para carregar o cookie
		    --2Âº acesse /diag para ver se o cookie foi recebido, ou inspecione o codigo no navegador para ver o cookie

		--passando por fora do middleware
			--1Âº acesse /diagini/cookie-testini para carregar o cookie
		    --2Âº acesse /diagini para ver se o cookie foi recebido, ou inspecione o codigo no navegador para ver o cookie

-----------------------------------------------------------------------------------------------------


Segue uma lista grande, organizada e completa, com praticamente tudo que realmente importou durante nossos testes, investigaÃ§Ãµes, validaÃ§Ãµes e correÃ§Ãµes no Syrios / SyriosIA dentro do Railway, Apache, FrankenPHP, PDF, cookies, sessÃ£o, storage, etc.

Essa lista serve para vocÃª marcar o que deseja salvar na memÃ³ria.
(NÃ£o vou salvar nada ainda â€” sÃ³ depois que vocÃª escolher.)

âœ… LISTA COMPLETA DAS INFORMAÃ‡Ã•ES IMPORTANTES

Organizada por temas para facilitar sua escolha.

ðŸ“Œ A. Railway â€” Infraestrutura e comportamento especÃ­fico
âœ… A1 â€” Sobre Dockerfile

Railway se comporta melhor SEM Dockerfile para aplicaÃ§Ãµes Laravel.

Quando o Dockerfile Ã© usado:

O app frequentemente retorna 502 Application failed to respond.

O Apache dentro do container perde configuraÃ§Ãµes essenciais.

As permissÃµes de storage ficam quebradas.

O deploy Ã© mais lento e causa inconsistÃªncias.

Para projetos Laravel, Railway prefere auto-detecÃ§Ã£o do build.

âœ… A2 â€” ExtensÃµes PHP no Railway

O Railway NÃƒO tem GD instalado no PHP.

Isso impede:

imagecreatefrompng

getimagesize para PNG

->loadView() com imagens PNG incorporadas

DomPDF falha com:

â€œThe PHP GD extension is required, but is not installed.â€

âœ… A3 â€” Storage no Railway

Storage funciona normalmente.

Symlink public/storage sempre existe se criado no deploy local.

Pode escrever, ler e deletar arquivos.

Storage no Railway fica em /app/storage/app/....

âœ… A4 â€” PDFs no Railway

Railway usa FrankenPHP atrÃ¡s do Apache/Nginx interno.

DomPDF funciona apenas se:

nÃ£o usar PNG

nÃ£o usar caminhos file:// com PNG

imagens devem ser JPG

remote enable deve estar habilitado (enable_remote=true)

Railway quebra PDFs se usar compressÃ£o ou buffering.

ðŸ“Œ B. SessÃµes / Cookies / Headers
âœ… B1 â€” Cookie de sessÃ£o

O cookie muda a cada requisiÃ§Ã£o, o que Ã© normal no Laravel.

SessÃ£o funciona corretamente mesmo se o cookie mudar.

O botÃ£o Logout limpa corretamente a sessÃ£o.

SessÃ£o expira corretamente conforme SESSION_LIFETIME.

âœ… B2 â€” Problemas resolvidos

Testes iniciais falharam porque:

O navegador nÃ£o apagava cookies no modo "keep alive".

SessÃ£o estava sendo criada em rotas pÃºblicas (normal).

SessÃ£o expira mesmo se SameSite estiver errado.

âœ… B3 â€” SameSite e HTTPS

Railway respeita:

SESSION_SECURE_COOKIE=true

SESSION_SAME_SITE=None

Chrome mostra Lax, mas isso Ã© interface, nÃ£o o cookie real.

âœ… B4 â€” TrustProxies no Railway

Precisa:

protected $proxies = '*';
protected $headers = Request::HEADER_X_FORWARDED_ALL;


Sem isso, Laravel nÃ£o detecta HTTPS.

ðŸ“Œ C. PDF â€” GeraÃ§Ã£o, erro, correÃ§Ãµes e limitaÃ§Ãµes
âœ… C1 â€” PNG proibido

PNG nÃ£o funciona no Railway porque depende de GD.

âœ… C2 â€” JPG permitido

JPG funciona 100%.

âœ… C3 â€” Base64 necessÃ¡rio

Para Railway, imagens precisam estar inline base64, nÃ£o file://.

safe_image_base64() Ã© obrigatÃ³rio.

âœ… C4 â€” Header de Download

->download() quebra no Railway.

SoluÃ§Ã£o universal:

return pdf_download($filename, $content);

âœ… C5 â€” CompressÃ£o e pdf_download()

Railway quebra PDF se houver:

zlib.output_compression

output_buffering

Transfer-Encoding: chunked

A funÃ§Ã£o pdf_download() resolve isso.

ðŸ“Œ D. DiagnÃ³sticos criados
âœ… D1 â€” Diag geral (waydiag)

Verifica:

Cookies

SessÃ£o

Headers

HTTPS

âœ… D2 â€” Diag de Storage

Testa:

symlink

escrita/leitura/deleÃ§Ã£o

raiz do storage

âœ… D3 â€” Diag PDF

Descobriu:

PNG falha

JPG funciona

Base64 funciona local e remotamente

output() quebra por causa do FrankenPHP

ðŸ“Œ E. MigraÃ§Ã£o Syrios â†’ SyriosIA
âœ… E1 â€” MigraÃ§Ã£o incremental funcionou

Migrou mÃ³dulos aos poucos.

Login â†’ Escolha escola â†’ Escolha role â†’ Dashboard â†’ OcorrÃªncias â†’ PDF.

âœ… E2 â€” SyriosIA Ã© mais estÃ¡vel porque:

NÃ£o usa Dockerfile.

NÃ£o carregou arquivos legados problemÃ¡ticos.

NÃ£o possui middlewares antigos quebrados.

ðŸ“Œ F. Regras essenciais aprendidas
âœ… F1 â€” Nunca usar PNG em PDFs no Railway.
âœ… F2 â€” Sempre usar imagens JPG + base64.
âœ… F3 â€” Usar pdf_download() sempre.
âœ… F4 â€” Evitar Dockerfile no Railway.
âœ… F5 â€” Manter symlink do storage.
âœ… F6 â€” Evitar caminhos absolutos file://.
âœ… F7 â€” DomPDF nÃ£o funciona com transparÃªncia (mesmo em JPG).
âœ… F8 â€” GeraÃ§Ã£o de PDF deve ser idempotente (sem eco, sem BOM).
âœ… F9 â€” Evitar includes Blade com PNG ou asset().
ðŸ“Œ G. Problemas reais resolvidos
âœ… G1 â€” Erro: 502 no Railway

Causa: Dockerfile interferindo no Apache.
SoluÃ§Ã£o: remover Dockerfile.

âœ… G2 â€” Erro: GD extension missing

Causa: Imagem PNG
SoluÃ§Ã£o: JPG + base64.

âœ… G3 â€” Erro: PDF 0 bytes

Causa: Railway + compressÃ£o chunked
SoluÃ§Ã£o: pdf_download().

âœ… G4 â€” SessÃ£o sumindo

Causa: Cookie nÃ£o apagava no Chrome
SoluÃ§Ã£o: limpar manualmente.

âœ… G5 â€” asset() nÃ£o funciona em PDFs

Causa: DomPDF local file loader
SoluÃ§Ã£o: inline base64.